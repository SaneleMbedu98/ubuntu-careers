<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Career Prep Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; margin: 0 auto; }
    h1, h2 { text-align: center; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    textarea { width: 100%; height: 100px; margin: 10px 0; resize: vertical; }
    button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    button:hover { background-color: #0056b3; }
    .output { 
      margin-top: 20px; 
      padding: 10px; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
      max-height: 200px; 
      overflow-y: auto; 
      white-space: pre-wrap; 
      word-wrap: break-word; 
    }
    input[type="file"], input[type="text"] { margin: 10px 0; width: 100%; }
  </style>
</head>
<body>
  <h1>Career Prep Tool</h1>
  
  <div class="section">
    <h2>Job Description</h2>
    <p>Enter a LinkedIn job URL to fetch the job description.</p>
    <input type="text" id="jobUrlInput" placeholder="E.g., https://www.linkedin.com/jobs/view/1234567890 or ...?currentJobId=1234567890" />
    <button onclick="fetchJobDescription()">Fetch Job Description</button>
    <textarea id="jobInput" placeholder="Job description will appear here or enter manually..."></textarea>
    <div id="jobOutput" class="output"></div>
  </div>

  <div class="section">
    <h2>Resume Input</h2>
    <p>Upload your CV (PDF or TXT) or enter it manually.</p>
    <input type="file" id="cvInput" accept=".pdf,.txt" />
    <textarea id="resumeInput" placeholder="CV content will appear here or enter manually..."></textarea>
    <button onclick="restructureCV()">Restructure CV</button>
    <button onclick="exportToPDF()">Export to PDF</button>
    <div id="resumeOutput" class="output"></div>
  </div>

  <div class="section">
    <h2>Interview Prep</h2>
    <p>Generate potential interview questions and answers based on the job description.</p>
    <button onclick="generateInterviewPrep()">Generate Questions</button>
    <div id="interviewOutput" class="output"></div>
  </div>

  <script>
    // Initialize pdf.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // Verify jsPDF loaded
    window.onload = () => {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        console.error('jsPDF failed to load');
        document.getElementById('resumeOutput').innerHTML = 'Error: PDF export library not loaded. Please refresh the page.';
      } else {
        console.log('jsPDF loaded successfully');
      }
    };

    // Fetch job description from LinkedIn URL
    async function fetchJobDescription() {
      try {
        const jobUrl = document.getElementById('jobUrlInput').value.trim();
        const urlPattern = /^https:\/\/www\.linkedin\.com\/jobs\/(view\/\d+|collections\/.*\?currentJobId=\d+)/;
        if (!jobUrl || !urlPattern.test(jobUrl)) {
          document.getElementById('jobOutput').innerHTML = 'Please enter a valid LinkedIn job URL (e.g., https://www.linkedin.com/jobs/view/1234567890 or ...?currentJobId=1234567890).';
          return;
        }

        document.getElementById('jobOutput').innerHTML = 'Fetching job description...';
        const response = await fetch('http://localhost:3001/fetch-job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: jobUrl })
        });

        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          throw new Error(data.error || `Server responded with status ${response.status}`);
        }

        const data = await response.json();
        if (!data.description) {
          throw new Error('No job description returned');
        }

        document.getElementById('jobInput').value = data.description;
        document.getElementById('jobOutput').innerHTML = 'Job description fetched successfully.';
      } catch (error) {
        console.error('Error fetching job description:', error);
        let message = 'Failed to fetch job description: ';
        if (error.message.includes('Server responded')) {
          message += `Backend error (${error.message}). Ensure the backend is running.`;
        } else if (error.message.includes('No job description')) {
          message += 'Job description not available for this URL.';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          message += 'Cannot connect to backend. Verify backend service is running.';
        } else if (error.message.includes('Invalid Proxycurl API key')) {
          message += 'Invalid Proxycurl API key. Check backend configuration.';
        } else if (error.message.includes('rate limit')) {
          message += 'Proxycurl API rate limit exceeded. Try again later.';
        } else {
          message += error.message || 'Unknown error. Check console and backend logs.';
        }
        message += ' You can enter the job description manually.';
        document.getElementById('jobOutput').innerHTML = message;
      }
    }

    // Handle CV upload
    document.getElementById('cvInput').addEventListener('change', async (event) => {
      try {
        const file = event.target.files[0];
        if (!file) return;
        if (!['application/pdf', 'text/plain'].includes(file.type)) {
          document.getElementById('resumeOutput').innerHTML = 'Please upload a PDF or TXT file.';
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          document.getElementById('resumeOutput').innerHTML = 'File size exceeds 5MB limit.';
          return;
        }

        let text = '';
        if (file.type === 'application/pdf') {
          text = await readPDF(file);
        } else {
          text = await readTextFile(file);
        }
        document.getElementById('resumeInput').value = text;
        document.getElementById('resumeOutput').innerHTML = 'CV uploaded successfully.';
      } catch (error) {
        console.error('Error processing CV:', error);
        document.getElementById('resumeOutput').innerHTML = 'Error processing CV. Please try again.';
      }
    });

    async function readPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text;
    }

    async function readTextFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
      });
    }

    // Restructure CV based on job description
    function restructureCV() {
      try {
        const job = document.getElementById('jobInput').value.trim();
        const resume = document.getElementById('resumeInput').value.trim();
        if (!job || !resume) {
          document.getElementById('resumeOutput').innerHTML = 'Please provide both job description and resume.';
          return;
        }

        const skills = extractSkills(job);
        const roleMatch = job.match(/(?:role|position)\s*:\s*([^\n.]+)/i);
        const role = roleMatch ? roleMatch[1].trim() : 'Unknown Role';

        const resumeSections = parseResume(resume);
        
        let restructured = `Restructured CV for ${role}\n\n`;
        restructured += `Summary\n- Tailored for ${role}, emphasizing skills: ${skills.join(', ')}\n\n`;

        if (resumeSections.skills) {
          const matchedSkills = resumeSections.skills.split(/[,;\n]/).filter(s => skills.includes(s.trim().toLowerCase()));
          restructured += `Skills\n- ${matchedSkills.join(', ') || 'Relevant skills not found'}\n\n`;
        }
        if (resumeSections.experience) {
          restructured += `Experience\n${resumeSections.experience.replace(new RegExp(skills.join('|'), 'gi'), m => `**${m}**`)}\n\n`;
        }
        if (resumeSections.education) {
          restructured += `Education\n${resumeSections.education}\n`;
        }

        document.getElementById('resumeOutput').innerHTML = restructured;
      } catch (error) {
        console.error('Error restructuring CV:', error);
        document.getElementById('resumeOutput').innerHTML = 'Error restructuring CV. Please check inputs.';
      }
    }

    // Export restructured CV to PDF
    function exportToPDF() {
      try {
        console.log('Starting PDF export...');
        if (!window.jspdf || !window.jspdf.jsPDF) {
          console.error('jsPDF not loaded');
          throw new Error('PDF export library not loaded');
        }

        const content = document.getElementById('resumeOutput').innerText.trim();
        if (!content) {
          console.warn('No content in resumeOutput');
          throw new Error('No restructured CV to export. Please restructure your CV first.');
        }

        console.log('Content to export:', content.substring(0, 100) + '...');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);

        const margin = 15;
        const maxWidth = 180;
        const lines = doc.splitTextToSize(content.replace(/\*\*/g, ''), maxWidth);
        console.log('Number of lines:', lines.length);

        let y = margin;
        const lineHeight = 7;
        lines.forEach(line => {
          if (y > 270) {
            doc.addPage();
            y = margin;
          }
          doc.text(line, margin, y);
          y += lineHeight;
        });

        doc.save('restructured_cv.pdf');
        console.log('PDF saved successfully');
        document.getElementById('resumeOutput').innerHTML = content + '\n\nCV exported as PDF.';
      } catch (error) {
        console.error('Error exporting to PDF:', error);
        document.getElementById('resumeOutput').innerHTML = 'Error exporting to PDF: ' + error.message;
      }
    }

    // Extract skills from job description
    function extractSkills(text) {
      const skillKeywords = ['python', 'javascript', 'tensorflow', 'machine learning', 'data science', 'sql', 'react', 'node.js', 'communication', 'leadership'];
      return skillKeywords.filter(kw => text.toLowerCase().includes(kw));
    }

    // Parse resume into sections
    function parseResume(resume) {
      const sections = { skills: '', experience: '', education: '' };
      const lines = resume.split('\n');
      let currentSection = '';
      for (const line of lines) {
        if (line.match(/skills/i)) currentSection = 'skills';
        else if (line.match(/experience|work history/i)) currentSection = 'experience';
        else if (line.match(/education/i)) currentSection = 'education';
        else if (currentSection) sections[currentSection] += line + '\n';
      }
      return sections;
    }

    // Generate interview questions and answers
    function generateInterviewPrep() {
      try {
        const job = document.getElementById('jobInput').value.trim();
        if (!job) {
          document.getElementById('interviewOutput').innerHTML = 'Please provide a job description.';
          return;
        }

        const skills = extractSkills(job);
        const roleMatch = job.match(/(?:role|position)\s*:\s*([^\n.]+)/i);
        const role = roleMatch ? roleMatch[1].trim() : 'Unknown Role';

        let output = `<h3>Interview Questions for ${role}</h3>`;
        const questions = [
          {
            question: `Can you describe your experience with ${skills[0] || 'a key skill'} in a professional or academic project?`,
            answer: `Highlight a project where you used ${skills[0] || 'relevant skills'}. E.g., "I developed a ${skills[0] || 'machine learning'} model using ${skills[0] || 'Python'} to predict customer churn, achieving 85% accuracy."`
          },
          {
            question: `How would you approach solving a complex problem in ${role}?`,
            answer: `Discuss your problem-solving process. E.g., "For a ${role} role, I’d analyze requirements, break the problem into tasks, and use tools like ${skills.join(' or ')} to implement a solution, testing iteratively."`
          },
          {
            question: `What motivates you to excel in a ${role} position?`,
            answer: `Connect to the job. E.g., "I’m passionate about ${skills[0] || 'innovation'} and want to contribute to ${role} by leveraging my ${skills.join(', ')} skills to drive impact."`
          }
        ];

        questions.forEach((q, i) => {
          output += `<p><strong>Question ${i + 1}:</strong> ${q.question}<br><strong>Sample Answer:</strong> ${q.answer}</p>`;
        });

        document.getElementById('interviewOutput').innerHTML = output;
      } catch (error) {
        console.error('Error generating interview prep:', error);
        document.getElementById('interviewOutput').innerHTML = 'Error generating questions. Please check job description.';
      }
    }
  </script>
</body>
</html>